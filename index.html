<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teleindicador Metro Bilbao y Bizkaibus</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
            margin-bottom: 20px;
        }
        h1 {
            color: #d10000; /* Color de Metro Bilbao */
            text-align: center;
            margin-bottom: 25px;
        }
        .input-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }
        label {
            font-weight: bold;
            color: #555;
        }
        input[type="text"],
        input[type="number"],
        select,
        button {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #d10000;
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #a00000;
        }
        .results-container {
            background-color: #e9e9e9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
            min-height: 150px;
            margin-top: 20px;
        }
        .direction-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .direction-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        h2 {
            color: #d10000;
            font-size: 20px;
            margin-top: 0;
            margin-bottom: 15px;
        }
        h3 {
            color: #007bff; /* Color para Bizkaibus */
            font-size: 18px;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        .train-info, .bus-info {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px 15px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column; /* Cambiado a columna para facilitar el apilamiento */
            justify-content: space-between;
            align-items: flex-start; /* Alinea los elementos a la izquierda */
            font-size: 1em;
            flex-wrap: wrap; 
        }
        .train-info strong, .bus-info strong {
            color: #333;
            width: 100%; /* Ocupa todo el ancho */
            margin-bottom: 5px;
        }
        .train-info span, .bus-info span {
            color: #666;
            width: 100%; /* Ocupa todo el ancho */
            text-align: left; /* Alinea a la izquierda por defecto */
            margin-bottom: 3px; /* Espacio entre las líneas de información */
        }
        .train-info span:last-of-type {
            margin-bottom: 0; /* Sin margen inferior en el último span */
        }

        .correspondence-text {
            color: green;
            font-weight: bold;
            margin-left: 10px;
            white-space: nowrap; /* Evita que el texto se rompa */
        }
        .no-results, .error-message {
            color: #d10000;
            font-weight: bold;
            text-align: center;
            padding: 10px;
        }
        .loading {
            text-align: center;
            font-size: 1.2em;
            color: #d10000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Teleindicador Metro Bilbao y Bizkaibus</h1>

        <div class="input-section">
            <label for="metroStationCode">Estación de Metro (Origen):</label>
            <select id="metroStationCode"></select> 
            <button onclick="displayNextArrivalsAndCorrespondence()">Mostrar Próximos Trenes y Correspondencias</button>
        </div>

        <div class="results-container" id="metroResults">
            <p class="loading">Cargando datos de Bizkaibus...</p>
        </div>

        <div class="results-container" id="bizkaibusResults">
            <h2>Próximos autobuses Bizkaibus (Parada 450 - Portugalete)</h2>
            <p class="loading">Cargando datos de Bizkaibus...</p>
        </div>
    </div>

    <script>
        let bizkaibusStopTimesData = [];
        let bizkaibusCalendarData = [];
        let bizkaibusCalendarDatesData = [];
        let bizkaibusTripsData = [];

        // Datos de las estaciones de Metro Bilbao
        const metroStations = [
            { code: "PLE", name: "Plentzia" },
            { code: "URD", name: "Urduliz" },
            { code: "SOP", name: "Sopela" },
            { code: "LAR", name: "Larrabasterra" },
            { code: "BER", name: "Berango" },
            { code: "IBB", name: "Ibarbengoa" },
            { code: "BID", name: "Bidezabal" },
            { code: "ALG", name: "Algorta" },
            { code: "AIB", name: "Aiboa" },
            { code: "NEG", name: "Neguri" },
            { code: "GOB", name: "Gobela" },
            { code: "ARE", name: "Areeta" },
            { code: "LAM", name: "Lamiako" },
            { code: "LEI", name: "Leioa" },
            { code: "AST", name: "Astrabudua" },
            { code: "ERA", name: "Erandio" },
            { code: "LUT", name: "Lutxana" },
            { code: "KAB", name: "Kabiezes" },
            { code: "STZ", name: "Santurtzi" },
            { code: "PEN", name: "Peñota" },
            { code: "POR", name: "Portugalete" },
            { code: "ABT", name: "Abatxolo" },
            { code: "SES", name: "Sestao" },
            { code: "URB", name: "Urbinaga" },
            { code: "BAG", name: "Bagatza" },
            { code: "BAR", name: "Barakaldo" },
            { code: "ANS", name: "Ansio" },
            { code: "GUR", name: "Gurutzeta / Cruces" },
            { code: "SIN", name: "San Ignazio" },
            { code: "SAR", name: "Sarriko" },
            { code: "DEU", name: "Deustu" },
            { code: "SAM", name: "Santimami / San Mamés" },
            { code: "IND", name: "Indautxu" },
            { code: "MOY", name: "Moyua" },
            { code: "ABA", name: "Abando" },
            { code: "CAV", name: "Zazpikaleak / Casco Viejo" },
            { code: "SAN", name: "Santutxu" },
            { code: "BAS", name: "Basarrate" },
            { code: "BOL", name: "Bolueta" },
            { code: "ETX", name: "Etxebarri" },
            { code: "ARZ", name: "Ariz" },
            { code: "BSR", name: "Basauri" }
        ];


        // URLs para los datos de Bizkaibus
        const bizkaibusStopTimesUrl = 'https://raw.githubusercontent.com/jaimeeeefer/teleindicadormb/refs/heads/main/parada450.txt';
        const bizkaibusCalendarUrl = 'https://raw.githubusercontent.com/jaimeeeefer/bizkaibus/refs/heads/main/calendar.txt';
        const bizkaibusCalendarDatesUrl = 'https://raw.githubusercontent.com/jaimeeeefer/bizkaibus/refs/heads/main/calendar_dates.txt';
        const bizkaibusTripsUrl = 'https://raw.githubusercontent.com/jaimeeeefer/bizkaibus/refs/heads/main/trips.txt';

        // URL para la API de Metro Bilbao
        const metroBilbaoApiBaseUrl = 'https://api.metrobilbao.eus/metro/real-time';
        const metroBilbaoDestinationCode = 'POR'; // Siempre Portugalete

        // Función para poblar el desplegable de estaciones de Metro
        function populateMetroStationsDropdown() {
            const selectElement = document.getElementById('metroStationCode');
            
            // Añadir opción por defecto "Selecciona una estación"
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Selecciona una estación...";
            defaultOption.selected = true;
            defaultOption.disabled = true;
            selectElement.appendChild(defaultOption);

            metroStations.forEach(station => {
                const option = document.createElement('option');
                option.value = station.code;
                option.textContent = `${station.name} (${station.code})`;
                selectElement.appendChild(option);
            });
            // Ya no seleccionamos Abando por defecto, la opción por defecto es "Selecciona una estación..."
        }

        async function loadBizkaibusData() {
            try {
                const [stopTimesResponse, calendarResponse, calendarDatesResponse, tripsResponse] = await Promise.all([
                    fetch(bizkaibusStopTimesUrl),
                    fetch(bizkaibusCalendarUrl),
                    fetch(bizkaibusCalendarDatesUrl),
                    fetch(bizkaibusTripsUrl)
                ]);

                bizkaibusStopTimesData = parseCSV(await stopTimesResponse.text());
                bizkaibusCalendarData = parseCSV(await calendarResponse.text());
                bizkaibusCalendarDatesData = parseCSV(await calendarDatesResponse.text());
                bizkaibusTripsData = parseCSV(await tripsResponse.text());

                document.getElementById('metroResults').innerHTML = '<p style="text-align: center;">Datos de Bizkaibus cargados. Selecciona una estación de Metro para buscar.</p>';
                document.getElementById('bizkaibusResults').innerHTML = '<h2>Próximos autobuses Bizkaibus (Parada 450 - Portugalete)</h2><p style="text-align: center;">Datos de Bizkaibus cargados.</p>';

            } catch (error) {
                console.error('Error loading Bizkaibus data:', error);
                document.getElementById('metroResults').innerHTML = '<p class="error-message">Error al cargar los datos de Bizkaibus. Por favor, inténtalo de nuevo más tarde.</p>';
                document.getElementById('bizkaibusResults').innerHTML = '<h2>Próximos autobuses Bizkaibus (Parada 450 - Portugalete)</h2><p class="error-message">Error al cargar los datos de Bizkaibus.</p>';
            }
        }

        // Helper function to parse CSV text into an array of objects
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const row = {};
                headers.forEach((header, i) => {
                    row[header.trim()] = values[i] ? values[i].trim() : '';
                });
                return row;
            });
        }

        // Helper function to get day of week for GTFS calendar
        function getDayOfWeek(date) {
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            return days[date.getDay()];
        }

        // Helper function to convert HH:MM:SS to minutes from midnight
        function convertTimeToMinutes(timeStr) {
            const parts = timeStr.split(':').map(Number);
            const hours = parts[0];
            const minutes = parts[1];
            const seconds = parts[2] || 0;
            return (hours * 60) + minutes + (seconds / 60);
        }

        // Helper function to convert minutes from midnight back to HH:MM format
        function formatMinutesToHHMM(minutesTotal) {
            const hours = Math.floor(minutesTotal / 60);
            const minutes = Math.round(minutesTotal % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        // Main function to display train arrivals and bus correspondences
        async function displayNextArrivalsAndCorrespondence() {
            const metroStationCode = document.getElementById('metroStationCode').value.trim().toUpperCase();
            const metroResultsContainer = document.getElementById('metroResults');
            const bizkaibusResultsContainer = document.getElementById('bizkaibusResults');
            
            metroResultsContainer.innerHTML = ''; // Clear previous Metro results
            bizkaibusResultsContainer.innerHTML = '<h2>Próximos autobuses Bizkaibus (Parada 450 - Portugalete)</h2>'; // Clear previous Bizkaibus results

            if (!metroStationCode) {
                metroResultsContainer.innerHTML = '<p class="error-message">Por favor, selecciona una estación de Metro.</p>';
                return;
            }

            // Validación: La estación de origen no puede ser Portugalete si el destino es Portugalete.
            if (metroStationCode === metroBilbaoDestinationCode) { // simplified check
                metroResultsContainer.innerHTML = '<p class="error-message">La estación de origen no puede ser Portugalete si el destino es Portugalete. Por favor, selecciona otra estación de origen.</p>';
                return;
            }


            const now = new Date();
            const currentDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;

            // --- Fetch Metro Bilbao data ---
            metroResultsContainer.innerHTML = '<p class="loading">Buscando trenes de Metro Bilbao...</p>';
            let metroBilbaoTrains = [];
            try {
                const metroApiUrl = `${metroBilbaoApiBaseUrl}/${metroStationCode}/${metroBilbaoDestinationCode}`;
                const response = await fetch(metroApiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Asegurarse de que data.trains y data.trip existan
                if (data && Array.isArray(data.trains) && data.trip) { 
                    const tripDurationMinutes = data.trip.duration;
                    const tripLine = data.trip.line;
                    const tripToStationName = data.trip.toStation.name;
                    const originStationName = metroStations.find(s => s.code === metroStationCode)?.name || metroStationCode;

                    metroBilbaoTrains = data.trains.map(train => {
                        const departureTimeFromOriginMinutes = convertTimeToMinutes(train.timeRounded);
                        // Usar la duración del viaje completo para calcular la llegada a Portugalete
                        const arrivalTimeAtPortugaleteMinutes = departureTimeFromOriginMinutes + tripDurationMinutes;

                        return {
                            departureTimeFromOrigin: train.timeRounded, // Hora de salida de la estación seleccionada
                            arrivalTimeAtPortugalete: formatMinutesToHHMM(arrivalTimeAtPortugaleteMinutes), 
                            line: tripLine, // La línea se obtiene del objeto trip
                            destination: tripToStationName, // El destino se obtiene del objeto trip
                            timeToArrivalAtPortugalete: arrivalTimeAtPortugaleteMinutes - currentTimeInMinutes
                        };
                    });
                } else {
                     console.warn('Metro Bilbao API response unexpected or empty trains array:', data);
                     metroResultsContainer.innerHTML = '<p class="no-results">Formato de respuesta de Metro Bilbao inesperado o no se encontraron trenes.</p>';
                }

            } catch (error) {
                console.error('Error fetching Metro Bilbao data:', error);
                metroResultsContainer.innerHTML = `<p class="error-message">Error al obtener datos de Metro Bilbao para ${metroStationCode}. (${error.message}).</p>`;
            }

            // --- Display Metro Bilbao results ---
            if (metroBilbaoTrains.length > 0) {
                const originStationNameForDisplay = metroStations.find(s => s.code === metroStationCode)?.name || metroStationCode;
                metroResultsContainer.innerHTML = `<h2>Próximos trenes de Metro Bilbao desde ${originStationNameForDisplay} hacia Portugalete</h2>`;
                // Sort trains by their calculated arrival time at Portugalete
                const sortedMetroTrains = metroBilbaoTrains.sort((a, b) => a.timeToArrivalAtPortugalete - b.timeToArrivalAtPortugalete);

                sortedMetroTrains.forEach(train => {
                    // Only show trains that are upcoming or just arrived (within 5 min past)
                    if (train.timeToArrivalAtPortugalete >= -5) {
                        const trainInfoDiv = document.createElement('div');
                        trainInfoDiv.classList.add('train-info');
                        trainInfoDiv.innerHTML = `
                            <strong>Línea ${train.line} hacia ${train.destination}</strong>
                            <span>Salida de ${originStationNameForDisplay}: ${train.departureTimeFromOrigin}</span>
                            <span>Llegada a Portugalete: ${train.arrivalTimeAtPortugalete} (en ${formatTime(train.timeToArrivalAtPortugalete, train.arrivalTimeAtPortugalete)})</span>
                        `;
                        metroResultsContainer.appendChild(trainInfoDiv);
                    }
                });
            } else {
                const originStationNameForDisplay = metroStations.find(s => s.code === metroStationCode)?.name || metroStationCode;
                metroResultsContainer.innerHTML = `<h2>Próximos trenes de Metro Bilbao desde ${originStationNameForDisplay} hacia Portugalete</h2><p class="no-results">No se encontraron trenes próximos para esta ruta de Metro Bilbao.</p>`;
            }

            // --- Calculate and Display Bizkaibus data and Correspondence ---
            const bizkaibusStopId = '450';

            const activeServiceIdsBizkaibus = getServiceIdsForDate(currentDay, bizkaibusCalendarData, bizkaibusCalendarDatesData);
            const stopTimesAtBizkaibusStation = bizkaibusStopTimesData.filter(st => st.stop_id === bizkaibusStopId);
            const relevantBizkaibusTrips = bizkaibusTripsData.filter(trip => activeServiceIdsBizkaibus.has(trip.service_id));
            const tripIdsWithServiceBizkaibus = new Set(relevantBizkaibusTrips.map(trip => trip.trip_id));

            const filteredBizkaibusStopTimes = stopTimesAtBizkaibusStation.filter(st => tripIdsWithServiceBizkaibus.has(st.trip_id));

            const bizkaibusDepartures = [];
            filteredBizkaibusStopTimes.forEach(stopTime => {
                const departureTimeInMinutes = convertTimeToMinutes(stopTime.departure_time);
                let timeDifference = departureTimeInMinutes - currentTimeInMinutes;

                // Handle times wrapping around midnight for GTFS (e.g., 25:00:00)
                // If a time is like 00:30 and current time is 23:00, it's next day
                if (timeDifference < 0 && (departureTimeInMinutes < (24 * 60) + 4 * 60) && (currentTimeInMinutes > (24 * 60) - 4 * 60)) { // Consider up to 4 AM next day
                     timeDifference += 24 * 60;
                } else if (timeDifference < -12 * 60) { // Catch buses from previous day if they appear far in the past
                    timeDifference += 24 * 60;
                }


                if (timeDifference >= 0 || (timeDifference > -5 && timeDifference < 0) ) { // Only future buses or those that just departed (within 5 min)
                    const trip = bizkaibusTripsData.find(t => t.trip_id === stopTime.trip_id);
                    if (trip) {
                        bizkaibusDepartures.push({
                            departureTime: stopTime.departure_time,
                            timeToDeparture: timeDifference,
                            headsign: stopTime.stop_headsign || trip.trip_headsign || 'Desconocido',
                            tripId: stopTime.trip_id
                        });
                    }
                }
            });

            if (bizkaibusDepartures.length === 0) {
                bizkaibusResultsContainer.innerHTML += '<p class="no-results">No se encontraron autobuses Bizkaibus próximos para la parada 450.</p>';
            } else {
                const sortedBizkaibus = bizkaibusDepartures.sort((a, b) => a.timeToDeparture - b.timeToDeparture);
                const nextRelevantBizkaibus = sortedBizkaibus.slice(0, 5); // Get next 5 relevant buses

                nextRelevantBizkaibus.forEach(bus => {
                    const busInfoDiv = document.createElement('div');
                    busInfoDiv.classList.add('bus-info');

                    const busDepartureTimeInMinutes = convertTimeToMinutes(bus.departureTime);
                    let correspondenceMessage = '';
                    let foundCorrespondence = false;

                    // Check for correspondence with Metro Bilbao trains
                    metroBilbaoTrains.forEach(metroTrain => {
                        const metroArrivalTimeInMinutes = convertTimeToMinutes(metroTrain.arrivalTimeAtPortugalete);
                        const timeDifferenceMetroBus = busDepartureTimeInMinutes - metroArrivalTimeInMinutes;

                        // Check if Metro arrives between 2 and 8 minutes BEFORE the bus departs
                        if (timeDifferenceMetroBus >= 2 && timeDifferenceMetroBus <= 8) {
                            // Only add message once per bus, even if multiple Metro trains could correspond
                            if (!foundCorrespondence) {
                                correspondenceMessage = `<span class="correspondence-text">Correspondencia</span>`;
                                foundCorrespondence = true;
                            }
                        }
                    });

                    busInfoDiv.innerHTML = `
                        <strong>Bizkaibus hacia ${bus.headsign}</strong>
                        <span>Salida: ${bus.departureTime} (en ${formatTime(bus.timeToDeparture, bus.departureTime)}) ${correspondenceMessage}</span>
                    `;
                    bizkaibusResultsContainer.appendChild(busInfoDiv);
                });
            }
        }

        // Helper functions from previous steps (formatTime, getServiceIdsForDate)
        function getServiceIdsForDate(date, calendar, calendarDates) {
            const yyyymmdd = date.getFullYear() * 10000 + (date.getMonth() + 1) * 100 + date.getDate();
            const dayOfWeek = getDayOfWeek(date);

            const activeServiceIds = new Set();

            calendar.forEach(service => {
                if (parseInt(service.start_date) <= yyyymmdd && parseInt(service.end_date) >= yyyymmdd) {
                    if (service[dayOfWeek] === '1') {
                        activeServiceIds.add(service.service_id);
                    }
                }
            });

            calendarDates.forEach(exception => {
                if (parseInt(exception.date) === yyyymmdd) {
                    if (exception.exception_type === '1') { // Service added
                        activeServiceIds.add(exception.service_id);
                    } else if (exception.exception_type === '2') { // Service removed
                        activeServiceIds.delete(exception.service_id);
                    }
                }
            });
            return activeServiceIds;
        }

        function formatTime(timeEstimated, timeRounded) {
            const formatMinutesToText = (minutes) => {
                if (minutes < -5) { // If it passed more than 5 minutes ago
                    return 'Pasado';
                } else if (minutes <= 0) { // If it's very soon or just passed
                    return 'En estación';
                } else if (minutes === 1) {
                    return '1 minuto';
                } else if (minutes < 60) {
                    return `${Math.round(minutes)} minutos`;
                } else {
                    const hours = Math.floor(minutes / 60);
                    const remainingMinutes = Math.round(minutes % 60);
                    return `${hours}h ${remainingMinutes}min`;
                }
            };

            const estimatedText = formatMinutesToText(timeEstimated);
            const roundedTimeText = (typeof timeRounded === 'string' && timeRounded.trim() !== '') ? timeRounded.trim() : 'N/A';

            return `${estimatedText} (aprox. ${roundedTimeText})`;
        }

        // Initial data load and dropdown population when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            populateMetroStationsDropdown();
            loadBizkaibusData();
        });
    </script>
</body>
</html>
